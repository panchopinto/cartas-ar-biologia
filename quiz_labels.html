<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Trivia (Etiquetas 3D) ‚Äî C√©lula Animal y Vegetal</title>
<link rel="icon" href="./assets/img/favicon.png">
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<style>
  :root{
    --bg:#08090c; --panel:#0f1117; --line:#263040; --text:#f5f7fb; --muted:#c9d5ea;
    --accent:#3cc9ff; --good:#39ff14; --bad:#ff4d6d; --target:#9ec6ff;
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 600px at 70% -10%,#112033 0%,transparent 60%), var(--bg);
    color:var(--text); font:500 16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;
    overflow:hidden; -webkit-user-select:none; user-select:none;
  }
  a{color:inherit;text-decoration:none}
  .wrap{display:grid; grid-template-columns:340px 1fr; gap:14px; height:100vh; padding:12px; max-width:1400px; margin:0 auto}
  .side{display:grid; grid-template-rows:auto auto 1fr auto; gap:10px}
  .panel{border:1px solid var(--line); border-radius:var(--radius); background:linear-gradient(180deg,#0b0f16,#0a0d13); box-shadow:var(--shadow); padding:12px}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .back{display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:12px; border:1px solid #2a3a4e; background:linear-gradient(180deg,#132132,#0d1623); color:#e8f7ff; font-weight:800}
  .modes{display:flex; gap:8px}
  .btn{cursor:pointer; border:1px solid #39536d; background:linear-gradient(180deg,#122033,#0d1623); color:#e8f7ff; font-weight:800; padding:8px 12px; border-radius:12px}
  .btn.active{background:rgba(60,201,255,.15); border-color:var(--accent)}
  .score{display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:800}
  .score .good{color:#b7ffb7} .score .bad{color:#ffb0be}
  .list{display:flex; flex-wrap:wrap; gap:8px}
  .chip{padding:8px 10px; border-radius:999px; border:1px solid #3a4e66; color:#cfe6ff; font:700 13px system-ui; background:linear-gradient(180deg,#0f1b2a,#0a1320)}
  .hint{color:var(--muted); font-size:13px; margin:4px 0 0}
  .bottom{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .legend{display:flex; gap:8px; flex-wrap:wrap; font-size:13px; color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block;vertical-align:middle;margin-right:6px}
  .ok{background:var(--good)} .ko{background:var(--bad)} .target{background:var(--target)}

  /* √Årea 3D */
  .stage{position:relative; border:1px solid var(--line); border-radius:var(--radius); overflow:hidden}
  a-scene{position:absolute; inset:0}
  /* MUY IMPORTANTE: permitir gestos en m√≥viles y no robarlos */
  canvas,.a-canvas{position:absolute; inset:0; width:100% !important; height:100% !important; background:#000 !important;
                    touch-action:none; overscroll-behavior:contain}

  .hud{position:absolute; left:10px; top:10px; display:flex; gap:8px; z-index:5}
  .hud .btn{padding:6px 10px}
  .toast{
    position:absolute; right:12px; top:12px; z-index:6; padding:8px 12px; border-radius:12px;
    border:1px solid #2a3a4e; background:linear-gradient(180deg,#122033,#0d1623); color:#e8f7ff; font-weight:800; display:none
  }
  .toast.show{display:block; animation:pop .25s ease}
  @keyframes pop{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}

  /* Etiquetas 3D */
  .label3d{pointer-events:auto}

  @media (max-width:960px){
    .wrap{grid-template-columns:1fr; grid-template-rows:auto 1fr; padding:10px}
    .stage{height:58vh}
  }
  @media (min-width:961px){
    .stage{height:calc(100vh - 24px)}
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- LADO IZQUIERDO -->
  <aside class="side">
    <div class="panel topbar">
      <a class="back" href="./index.html">‚Üê Volver</a>
      <div class="modes" role="tablist" aria-label="Modo de trivia">
        <button id="modeAnimal" class="btn active" role="tab" aria-selected="true">Animal</button>
        <button id="modeVegetal" class="btn" role="tab" aria-selected="false">Vegetal</button>
      </div>
    </div>

    <div class="panel score">
      <div>Correctas: <span id="ok">0</span> ¬∑ Incorrectas: <span id="ko">0</span></div>
      <div id="progressMini">0 / <span id="total">0</span></div>
    </div>

    <div class="panel">
      <div style="font-weight:800;margin-bottom:6px">Etiquetas a ubicar</div>
      <div id="chips" class="list" aria-live="polite"></div>
      <div class="hint">Tip: rota con 1 dedo / mouse, pellizca para zoom, mueve con 2 dedos o Shift+arrastre. Toca una etiqueta para ‚Äútomarla‚Äù y ub√≠cala sobre la c√©lula.</div>
    </div>

    <div class="panel bottom">
      <div class="legend">
        <span><i class="dot target"></i>Objetivo</span>
        <span><i class="dot ok"></i>Correcto</span>
        <span><i class="dot ko"></i>Incorrecto</span>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnAyuda" class="btn">Ayuda</button>
        <button id="btnReset" class="btn">Reiniciar</button>
      </div>
    </div>
  </aside>

  <!-- ESCENA 3D -->
  <main class="stage">
    <div class="hud">
      <button id="btnAuto" class="btn" title="Auto-rotaci√≥n">Auto</button>
      <button id="btnCenter" class="btn" title="Centrar">‚óé</button>
      <button id="btnResetView" class="btn" title="Reset vista">‚ü≤</button>
    </div>
    <div id="toast" class="toast">¬°Bien!</div>

    <a-scene embedded renderer="antialias:true;precision:mediump" background="color:#000">
      <a-entity light="type:ambient; intensity:0.9"></a-entity>
      <a-entity light="type:directional; intensity:0.8" position="1 1 0"></a-entity>

      <a-entity id="cellModel"
        position="0 0 0" rotation="0 0 0" scale="0.40 0.40 0.40"
        gesture-handler="minScale:0.20; maxScale:3.0; rotFactor:0.5"
        pinch-pan-pe="min:0.20; max:3.0; factor:1; panFactor:1.0"
        mouse-drag-rotate
        mouse-pan="panFactor:1.0"
        tap-reset="scale:0.40; rotYdeg:0"
        auto-rotator="enabled:false; speed:18"></a-entity>

      <a-entity id="cameraRig">
        <!-- üëá cursor + raycaster dirigidos a las etiquetas -->
        <a-entity camera position="0 0 1.6"
                  cursor="rayOrigin: mouse"
                  raycaster="objects: .label3d; far: 10"></a-entity>
      </a-entity>
    </a-scene>
  </main>
</div>

<script>
/* Flag global para pausar rotaci√≥n/pan mientras arrastras una etiqueta */
window.DRAG_LABEL = false;

/* ====== Gestos (igual que viewer pero respetando DRAG_LABEL) ====== */
AFRAME.registerComponent('gesture-handler',{schema:{rotFactor:{default:0.45},minScale:{default:0.05},maxScale:{default:3.0}},
  init:function(){this.oneFinger=false;this.lastX=0;const s=this.el.sceneEl;const add=()=>{const t=s.canvas||s;
    t.addEventListener('touchstart',e=>{if(e.touches.length===1){this.oneFinger=true;this.lastX=e.touches[0].clientX;}},{passive:false});
    t.addEventListener('touchmove',e=>{if(window.DRAG_LABEL) return;
      if(this.oneFinger&&e.touches.length===1){const dx=e.touches[0].clientX-this.lastX;this.lastX=e.touches[0].clientX;
        this.el.object3D.rotation.y-=(dx*this.data.rotFactor)*Math.PI/180;e.preventDefault();}},{passive:false});
    t.addEventListener('touchend',()=>{this.oneFinger=false;},{passive:false});
    t.addEventListener('touchcancel',()=>{this.oneFinger=false;},{passive:false});
    t.addEventListener('wheel',e=>{if(window.DRAG_LABEL) return; e.preventDefault();
      const dir=e.deltaY>0?0.9:1.1;const s=this.el.object3D.scale.x*dir;
      const cl=THREE.MathUtils.clamp(s,this.data.min,this.data.max);this.el.object3D.scale.set(cl,cl,cl);},{passive:false});
    t.addEventListener('contextmenu',(e)=>e.preventDefault());
  }; s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});

AFRAME.registerComponent('mouse-drag-rotate',{schema:{factor:{default:0.45}},
  init:function(){this.drag=false;this.lastX=0;const s=this.el.sceneEl;const add=()=>{const t=s.canvas||s;
    t.addEventListener('mousedown',e=>{ if(window.DRAG_LABEL) return; if(e.button===0){ this.drag=true; this.lastX=e.clientX; }});
    window.addEventListener('mouseup',()=>{this.drag=false;});
    window.addEventListener('mousemove',e=>{ if(window.DRAG_LABEL) return; if(!this.drag) return;
      const dx=e.clientX-this.lastX; this.lastX=e.clientX;
      this.el.object3D.rotation.y -= (dx*this.data.factor)*Math.PI/180; });
  }; s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});

AFRAME.registerComponent('pinch-pan-pe',{schema:{min:{default:0.2},max:{default:3.0},factor:{default:1},panFactor:{default:1}},
  init:function(){
    this.pointers=new Map(); this.active=false; this.startDist=0; this.startScale=this.el.object3D.scale.x;
    this.startCentroid={x:0,y:0}; this.startPos=this.el.object3D.position.clone();
    const s=this.el.sceneEl;
    const centroid=()=>{ const a=[...this.pointers.values()]; return {x:(a[0].x+a[1].x)/2, y:(a[0].y+a[1].y)/2}; };
    const dist=()=>{ const a=[...this.pointers.values()]; const dx=a[0].x-a[1].x, dy=a[0].y-a[1].y; return Math.hypot(dx,dy); };
    const worldPerPixel = ()=>{ const cam = s.camera; if(!cam || !s.canvas) return {x:0,y:0};
      const fov = (cam.fov||60)*Math.PI/180; const h = s.canvas.height || window.innerHeight;
      const worldPerPixY = 2 * cam.position.length() * Math.tan(fov/2) / h; const worldPerPixX = worldPerPixY * cam.aspect; return {x:worldPerPixX, y:worldPerPixY}; };
    const onDown=(e)=>{ const c=s.canvas||s; c.setPointerCapture?.(e.pointerId); this.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
      if(this.pointers.size===2){ this.active=true; this.startDist=dist(); this.startScale=this.el.object3D.scale.x; this.startCentroid=centroid(); this.startPos=this.el.object3D.position.clone(); } };
    const onMove=(e)=>{ if(window.DRAG_LABEL) return; if(!this.pointers.has(e.pointerId)) return; this.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
      if(this.active && this.pointers.size===2){ e.preventDefault(); const k=(dist()/this.startDist)*this.data.factor;
        let sc=THREE.MathUtils.clamp(this.startScale*k, this.data.min, this.data.max); this.el.object3D.scale.set(sc,sc,sc);
        const cen=centroid(); const dx=cen.x-this.startCentroid.x; const dy=cen.y-this.startCentroid.y; const wp=worldPerPixel();
        const tx = dx * wp.x * this.data.panFactor; const ty = -dy * wp.y * this.data.panFactor;
        this.el.object3D.position.set(this.startPos.x + tx, this.startPos.y + ty, this.startPos.z); } };
    const onUp=(e)=>{ this.pointers.delete(e.pointerId); if(this.pointers.size<2) this.active=false; };
    const add=()=>{ const c=s.canvas||s; c.addEventListener('pointerdown',onDown,{passive:false});
      c.addEventListener('pointermove',onMove,{passive:false}); c.addEventListener('pointerup',onUp,{passive:false});
      c.addEventListener('pointercancel',onUp,{passive:false}); c.addEventListener('pointerout',onUp,{passive:false}); c.addEventListener('pointerleave',onUp,{passive:false}); };
    s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});
  }
});

AFRAME.registerComponent('mouse-pan',{schema:{panFactor:{default:1}},
  init:function(){
    const s=this.el.sceneEl; let down=false, start={x:0,y:0}, startPos=this.el.object3D.position.clone(), shift=false;
    const worldPerPixel = ()=>{ const cam = s.camera; if(!cam || !s.canvas) return {x:0,y:0}; const fov = (cam.fov||60)*Math.PI/180;
      const h = s.canvas.height || window.innerHeight; const y = 2 * cam.position.length() * Math.tan(fov/2) / h; const x = y * cam.aspect; return {x, y}; };
    const onDown=(e)=>{ if(window.DRAG_LABEL) return; shift=e.shiftKey; if (e.button===1 || e.button===2 || (e.button===0 && shift)){ down=true; start={x:e.clientX,y:e.clientY}; startPos=this.el.object3D.position.clone(); e.preventDefault(); } };
    const onMove=(e)=>{ if(window.DRAG_LABEL) return; if(!down) return; e.preventDefault(); const dx=e.clientX-start.x, dy=e.clientY-start.y; const wp=worldPerPixel();
      const tx = dx * wp.x * this.data.panFactor; const ty = -dy * wp.y * this.data.panFactor; this.el.object3D.position.set(startPos.x + tx, startPos.y + ty, startPos.z); };
    const onUp=()=>{ down=false; };
    const add=()=>{ const c=s.canvas||s; c.addEventListener('mousedown',onDown,{passive:false}); window.addEventListener('mousemove',onMove,{passive:false});
      window.addEventListener('mouseup',onUp,{passive:false}); c.addEventListener('contextmenu',(e)=>e.preventDefault()); };
    s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});
  }
});
AFRAME.registerComponent('tap-reset',{schema:{scale:{default:1},rotYdeg:{default:0}},init:function(){this.lastTap=0;const s=this.el.sceneEl;const add=()=>{const t=s.canvas||s;
  t.addEventListener('touchend',()=>{const n=performance.now();if(n-this.lastTap<300){const sc=this.data.scale;this.el.object3D.scale.set(sc,sc,sc);
    this.el.object3D.rotation.y=THREE.MathUtils.degToRad(this.data.rotYdeg);}this.lastTap=n;},{passive:true});};s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});

AFRAME.registerComponent('auto-rotator',{schema:{speed:{default:18},enabled:{default:false}},tick:function(t,dt){ if(!this.data.enabled)return; this.el.object3D.rotation.y+=THREE.MathUtils.degToRad(this.data.speed)*(dt/1000); }});
AFRAME.registerComponent('billboard',{tick:function(){const cam=this.el.sceneEl&&this.el.sceneEl.camera;if(!cam)return;this.el.object3D.quaternion.copy(cam.el.object3D.quaternion);}});

/* ====== Datos ====== */
const MAP={
  animal:{normal:"./assets/models/animal.glb",draco:"./assets/models/animal_draco.glb"},
  vegetal:{normal:"./assets/models/vegetal.glb",draco:"./assets/models/vegetal_draco.glb"}
};
const TARGETS={
  animal:[
    {name:'N√∫cleo',pos:[0,0.12,0]},
    {name:'Mitocondrias',pos:[0.18,0.06,0.04]},
    {name:'Aparato de Golgi',pos:[0.12,0.00,-0.15]},
    {name:'Ribosomas',pos:[-0.18,0.08,0]},
    {name:'Lisosomas',pos:[-0.12,-0.02,0.14]},
    {name:'Centriolos',pos:[0.16,0.14,-0.02]}
  ],
  vegetal:[
    {name:'N√∫cleo',pos:[0,0.12,0]},
    {name:'Cloroplastos',pos:[0.18,0.05,0]},
    {name:'Vacuola central',pos:[-0.12,0.02,-0.1]},
    {name:'Pared celular',pos:[0,0,-0.22]},
    {name:'Plasmodesmos',pos:[-0.20,0.00,0.12]},
    {name:'Aparato de Golgi',pos:[0.12,0,-0.15]}
  ]
};

/* ====== Estado/UI ====== */
const modeAnimalBtn = document.getElementById('modeAnimal');
const modeVegetalBtn = document.getElementById('modeVegetal');
const chipsBox = document.getElementById('chips');
const okEl = document.getElementById('ok'); const koEl = document.getElementById('ko');
const progressMini = document.getElementById('progressMini'); const totalEl = document.getElementById('total');
const toast = document.getElementById('toast');
const btnAuto = document.getElementById('btnAuto'); const btnCenter = document.getElementById('btnCenter'); const btnResetView = document.getElementById('btnResetView');
const btnReset = document.getElementById('btnReset'); const btnAyuda = document.getElementById('btnAyuda');

const modelEl = document.getElementById('cellModel');
const scene = document.querySelector('a-scene');
let kind='animal', done=new Set(), wrong=0;
let DEFAULT_SCALE=1.0;
let targetDots=[], labels=[]; // etiquetas 3D

/* ====== Util ====== */
function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'),1000); }
function resetScore(){ done.clear(); wrong=0; updateScore(); }
function updateScore(){ okEl.textContent = done.size; koEl.textContent = wrong; progressMini.innerHTML = `${done.size} / <span id="total">${TARGETS[kind].length}</span>`; }
function distance(a,b){ const dx=a.x-b[0], dy=a.y-b[1], dz=a.z-b[2]; return Math.hypot(dx,dy,dz); }

/* ====== Normalizar + encuadrar ====== */
function frameCameraOnly(){
  const THREE = window.THREE; const cam = scene.camera; if(!cam) return;
  const box = new THREE.Box3().setFromObject(modelEl.object3D);
  const sphere = box.getBoundingSphere(new THREE.Sphere());
  const radius = sphere.radius * 1.12;
  const fov = (cam.fov||60) * Math.PI/180; const aspect = cam.aspect || (scene.canvas ? scene.canvas.width/scene.canvas.height : 1.777);
  const distV = radius / Math.sin(fov/2);
  const hFov = 2 * Math.atan(Math.tan(fov/2) * aspect);
  const distH = radius / Math.sin(hFov/2);
  const dist = Math.max(distV, distH);
  cam.el.setAttribute('position', `0 0 ${dist.toFixed(4)}`); cam.near=Math.max(0.01,dist*0.01); cam.far=dist*10; cam.updateProjectionMatrix();
}
function normalizeAndFrame(){
  const THREE = window.THREE; const mesh = modelEl.getObject3D('mesh'); if(!mesh) return;
  const box = new THREE.Box3().setFromObject(mesh);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());
  const maxDim = Math.max(size.x,size.y,size.z) || 1;
  mesh.position.sub(center);
  const s = 0.30 / maxDim;
  modelEl.object3D.scale.set(s,s,s); DEFAULT_SCALE=s;
  frameCameraOnly();
}

/* ====== Puntos objetivo (ayuda) ====== */
function clearTargetDots(){ targetDots.forEach(e=>e.parentNode && e.parentNode.removeChild(e)); targetDots=[]; }
function makeTargetDots(){
  clearTargetDots();
  TARGETS[kind].forEach(t=>{
    const dot=document.createElement('a-entity');
    dot.setAttribute('geometry','primitive: sphere; radius: 0.018');
    dot.setAttribute('material',`color:${'#9ec6ff'}; emissive:${'#1a9fff'}; emissiveIntensity:0.7; opacity:0.95`);
    dot.setAttribute('position', t.pos.join(' '));
    dot.setAttribute('visible','false'); // oculto por defecto; se enciende con ‚ÄúAyuda‚Äù
    modelEl.appendChild(dot);
    targetDots.push(dot);
  });
}

/* ====== Etiquetas 3D arrastrables ====== */
function clearLabels(){ labels.forEach(L=>L.el.parentNode && L.el.parentNode.removeChild(L.el)); labels=[]; }
function labelMaterial(baseColor='#0b1a2b'){ return `color:${baseColor}; opacity:0.92; side:double; metalness:0; roughness:1;`; }

function createLabel(name, idx, total){
  const wrap=document.createElement('a-entity'); wrap.setAttribute('billboard','');

  // fondo (¬°con clase para raycaster!)
  const bg=document.createElement('a-entity');
  bg.classList.add('label3d');
  bg.setAttribute('geometry','primitive: plane; width: 0.32; height: 0.10');
  bg.setAttribute('material', labelMaterial());

  // texto
  const txt=document.createElement('a-text');
  txt.setAttribute('value',name); txt.setAttribute('color','#cfe6ff'); txt.setAttribute('align','center'); txt.setAttribute('width','1.2'); txt.setAttribute('baseline','center');

  wrap.appendChild(bg); wrap.appendChild(txt);

  // posici√≥n inicial en aro
  const r=0.42, ang = (idx/total)*Math.PI*1.4 - Math.PI*0.7;
  wrap.setAttribute('position', `${Math.cos(ang)*r} ${0.18 - (idx%3)*0.18} ${Math.sin(ang)*r}`);

  // meta
  const target = TARGETS[kind].find(t=>t.name===name);
  const L={name, el:wrap, target:target.pos, locked:false, home:wrap.object3D.position.clone()};
  labels.push(L);

  // Componente para arrastrar (lo montamos en el WRAP para mover todo el bloque)
  wrap.setAttribute('draggable-label', `name:${name}`);
  modelEl.appendChild(wrap);
}

AFRAME.registerComponent('draggable-label',{
  schema:{name:{default:''}},
  init:function(){
    const s=this.el.sceneEl;
    const canvas = ()=> s.canvas || s;
    this.dragging=false; this.startPos=this.el.object3D.position.clone();
    this.preview=null;

    const ensurePreview=()=>{ if(this.preview) return;
      this.preview=document.createElement('a-entity');
      this.preview.setAttribute('geometry','primitive: ring; radiusInner:0.022; radiusOuter:0.032');
      this.preview.setAttribute('material',`color:#ffffff; emissive:#ffffff; emissiveIntensity:0.9; opacity:0.85`);
      this.preview.setAttribute('rotation','90 0 0');
      this.preview.setAttribute('visible','false');
      document.getElementById('cellModel').appendChild(this.preview);
    };

    const raycaster = new THREE.Raycaster(), mouse = new THREE.Vector2();
    const worldPointFromClient=(x,y)=>{
      const c = canvas(); const rect = c.getBoundingClientRect();
      const nx = ((x-rect.left)/rect.width)*2 - 1; const ny = -((y-rect.top)/rect.height)*2 + 1;
      mouse.set(nx,ny); raycaster.setFromCamera(mouse, s.camera);
      const mesh = document.getElementById('cellModel').getObject3D('mesh'); if(!mesh) return null;
      const ints = raycaster.intersectObject(mesh, true); return (ints && ints[0]) ? ints[0].point : null;
    };
    const toLocal=(pWorld)=>{ const m=document.getElementById('cellModel').object3D; const p=pWorld.clone(); m.worldToLocal(p); return p; };
    const getXY=(e)=> e.touches && e.touches[0] ? {x:e.touches[0].clientX,y:e.touches[0].clientY} : {x:e.clientX,y:e.clientY};

    const onMove=(e)=>{
      if(!this.dragging) return;
      const {x,y}=getXY(e);
      const p = worldPointFromClient(x,y);
      if(!p){ this.preview && this.preview.setAttribute('visible','false'); return; }
      ensurePreview();
      this.preview.setAttribute('position', p);
      this.preview.setAttribute('visible','true');
      const local = toLocal(p);
      this.el.object3D.position.copy(local);
      e.preventDefault?.();
    };

    const finish=(ok, home, targetArr, me)=>{
      window.DRAG_LABEL=false; this.dragging=false;
      this.preview && this.preview.setAttribute('visible','false');

      if(ok){
        this.el.object3D.position.set(targetArr[0],targetArr[1],targetArr[2]);
        this.el.setAttribute('colorize','state:ok');
        me.locked=true; done.add(me.name); updateScore(); pingMark(targetArr); showToast('¬°Correcto!');
        if(done.size === TARGETS[kind].length) showToast('¬°Perfecto!');
      }else{
        shakeEntity(this.el);
        setTimeout(()=> this.el.object3D.position.copy(home), 150);
        wrong++; updateScore(); showToast('Intenta de nuevo');
      }
    };

    const onUp=(e)=>{
      if(!this.dragging) return;
      const me = labels.find(x=>x.el===this.el); if(!me) return;
      const pos = this.el.object3D.position; const tol=0.10;
      const ok = distance(pos, me.target) <= tol;
      finish(ok, me.home || this.startPos, me.target, me);
      window.removeEventListener('pointermove', onMove, {passive:false});
      window.removeEventListener('mousemove', onMove, {passive:false});
      window.removeEventListener('touchmove', onMove, {passive:false});
      window.removeEventListener('pointerup', onUp, {passive:false});
      window.removeEventListener('mouseup', onUp, {passive:false});
      window.removeEventListener('touchend', onUp, {passive:false});
      window.removeEventListener('touchcancel', onUp, {passive:false});
    };

    const startDrag=(e)=>{
      // evita conflicto con rotaci√≥n / pan
      window.DRAG_LABEL=true;
      this.dragging=true; this.startPos=this.el.object3D.position.clone();
      ensurePreview();
      // escuchas globales mientras arrastro
      window.addEventListener('pointermove', onMove, {passive:false});
      window.addEventListener('mousemove', onMove, {passive:false});
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('pointerup', onUp, {passive:false});
      window.addEventListener('mouseup', onUp, {passive:false});
      window.addEventListener('touchend', onUp, {passive:false});
      window.addEventListener('touchcancel', onUp, {passive:false});
      e.preventDefault?.();
      e.stopPropagation?.();
    };

    const add=()=>{
      // OJO: los eventos ‚Äúdown‚Äù vienen del cursor/raycaster ‚Üí usamos mousedown/touchstart
      this.el.addEventListener('mousedown', startDrag);
      this.el.addEventListener('touchstart', startDrag, {passive:false});
    };
    s.hasLoaded ? add() : s.addEventListener('loaded', add, {once:true});
  }
});

/* Efecto color estado en etiqueta */
AFRAME.registerComponent('colorize',{
  schema:{state:{default:'idle'}},
  update:function(){
    const bg=this.el.children[0];
    if(!bg) return;
    if(this.data.state==='ok'){
      bg.setAttribute('material','color:#0f2512; opacity:0.96; side:double');
      const ring=document.createElement('a-entity');
      ring.setAttribute('geometry','primitive: ring; radiusInner:0.05; radiusOuter:0.065');
      ring.setAttribute('material',`color:${'#b0ffb0'}; emissive:${'#39ff14'}; emissiveIntensity:0.9; opacity:0.95`);
      ring.setAttribute('rotation','90 0 0');
      ring.setAttribute('position','0 -0.02 0');
      this.el.appendChild(ring);
      setTimeout(()=>{ ring.parentNode && ring.parentNode.removeChild(ring); }, 1200);
    }else{
      bg.setAttribute('material','color:#0b1a2b; opacity:0.92; side:double');
    }
  }
});

/* Util: ‚Äúshake‚Äù suave */
function shakeEntity(el){
  const n=el.object3D; const a=[0,0.06,-0.06,0.04,-0.04,0]; let i=0;
  const startY=n.position.y; const t=setInterval(()=>{ if(i>=a.length){ clearInterval(t); n.position.y=startY; return; }
    n.position.y=startY + a[i]; i++; }, 30);
}

/* Puntos ‚Äúping‚Äù */
function pingMark(pos){
  const e=document.createElement('a-entity');
  e.setAttribute('geometry','primitive: torus; radius: 0.05; radiusTubular: 0.006');
  e.setAttribute('material',`color:${'#b0ffb0'}; emissive:${'#39ff14'}; emissiveIntensity:0.9; opacity:0.9`);
  e.setAttribute('rotation','90 0 0'); e.setAttribute('position', pos.join(' '));
  modelEl.appendChild(e);
  setTimeout(()=>{ e.parentNode && e.parentNode.removeChild(e); }, 1200);
}

/* ====== Chips de referencia (panel izquierdo) ====== */
function renderChipList(){
  chipsBox.innerHTML='';
  const arr = TARGETS[kind].map(t=>t.name).sort((a,b)=>a.localeCompare(b));
  arr.forEach(name=>{
    const el=document.createElement('div');
    el.className='chip';
    el.textContent=name;
    chipsBox.appendChild(el);
  });
  totalEl.textContent = TARGETS[kind].length;
}

/* ====== Modelo ====== */
async function exists(u){ try{ const r=await fetch(u+'?t='+Date.now(),{method:'HEAD'}); return r.ok; }catch{return false;} }
async function pick(){ const e=MAP[kind]; return (await exists(e.draco))?e.draco:e.normal; }
async function loadModel(){
  const url=(await pick())+'#'+Date.now();
  modelEl.removeAttribute('gltf-model');
  modelEl.object3D.position.set(0,0,0);
  modelEl.object3D.rotation.set(0,0,0);
  modelEl.object3D.scale.set(0.4,0.4,0.4);
  setTimeout(()=>modelEl.setAttribute('gltf-model',url),30);
}

/* ====== Crear etiquetas para el modo ====== */
function spawnLabels(){
  clearLabels();
  const names = TARGETS[kind].map(t=>t.name);
  names.forEach((n,i)=> createLabel(n, i, names.length));
}

/* ====== Botones HUD ====== */
btnAuto.addEventListener('click', ()=>{
  const on = btnAuto.classList.toggle('active');
  modelEl.setAttribute('auto-rotator',`enabled:${on}; speed:18`);
});
btnCenter.addEventListener('click', ()=> modelEl.object3D.position.set(0,0,0));
btnResetView.addEventListener('click', ()=>{
  modelEl.object3D.position.set(0,0,0);
  modelEl.object3D.rotation.set(0,0,0);
  modelEl.object3D.scale.set(DEFAULT_SCALE,DEFAULT_SCALE,DEFAULT_SCALE);
});

/* Ayuda: mostrar/ocultar metas */
let ayudaOn=false;
btnAyuda.addEventListener('click', ()=>{
  ayudaOn=!ayudaOn;
  targetDots.forEach(d=> d.setAttribute('visible', ayudaOn));
  btnAyuda.classList.toggle('active', ayudaOn);
});

/* Cambio de modo */
function setMode(m){
  if(kind===m) return;
  kind=m;
  modeAnimalBtn.classList.toggle('active', kind==='animal');
  modeVegetalBtn.classList.toggle('active', kind==='vegetal');
  resetScore(); renderChipList(); clearTargetDots(); makeTargetDots(); spawnLabels(); loadModel();
}
modeAnimalBtn.onclick = ()=> setMode('animal');
modeVegetalBtn.onclick = ()=> setMode('vegetal');

/* Reiniciar */
btnReset.onclick = ()=>{
  resetScore(); renderChipList();
  clearTargetDots(); makeTargetDots();
  spawnLabels();
};

/* Inicial */
modelEl.addEventListener('model-loaded', ()=>{ normalizeAndFrame(); });
modelEl.addEventListener('model-error', e=>{ alert('No se pudo cargar el modelo'); console.error(e.detail); });

(function init(){
  const m = (new URLSearchParams(location.search).get('m')||'animal').toLowerCase();
  kind = (m==='vegetal') ? 'vegetal' : 'animal';
  modeAnimalBtn.classList.toggle('active', kind==='animal');
  modeVegetalBtn.classList.toggle('active', kind==='vegetal');
  resetScore(); renderChipList(); makeTargetDots(); spawnLabels(); loadModel();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Trivia (Arrastrar etiquetas) — Célula Animal y Vegetal</title>
<link rel="icon" href="./assets/img/favicon.png">
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<style>
  :root{
    --bg:#08090c; --panel:#0f1117; --line:#263040; --text:#f5f7fb; --muted:#c9d5ea;
    --accent:#3cc9ff; --good:#39ff14; --bad:#ff4d6d; --target:#9ec6ff;
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 600px at 70% -10%,#112033 0%,transparent 60%), var(--bg);
    color:var(--text); font:500 16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;
    overflow:auto;
  }
  a{color:inherit;text-decoration:none}

  /* Evita que el navegador bloquee gestos táctiles */
  canvas.a-canvas, a-scene {
    touch-action:none;
    -ms-touch-action:none;
    overscroll-behavior:contain;
  }

  /* Layout */
  .wrap{
    display:grid; grid-template-columns:340px 1fr; gap:14px;
    min-height:100vh; padding:12px; max-width:1400px; margin:0 auto;
  }
  .side{display:grid; grid-template-rows:auto auto auto auto; gap:10px}
  .panel{border:1px solid var(--line); border-radius:var(--radius); background:linear-gradient(180deg,#0b0f16,#0a0d13); box-shadow:var(--shadow); padding:12px}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .back{display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:12px; border:1px solid #2a3a4e; background:linear-gradient(180deg,#132132,#0d1623); color:#e8f7ff; font-weight:800}
  .modes{display:flex; gap:8px; flex-wrap:wrap}
  .btn{cursor:pointer; border:1px solid #39536d; background:linear-gradient(180deg,#122033,#0d1623); color:#e8f7ff; font-weight:800; padding:8px 12px; border-radius:12px}
  .btn.active{background:rgba(60,201,255,.15); border-color:var(--accent)}
  .score{display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:800}
  .score .good{color:#b7ffb7} .score .bad{color:#ffb0be}

  .list{display:flex; flex-wrap:wrap; gap:8px; max-height:260px; overflow:auto}
  .chip{
    padding:8px 10px; border-radius:999px; border:1px solid #3a4e66; color:#cfe6ff;
    font:700 13px system-ui; background:linear-gradient(180deg,#0f1b2a,#0a1320); user-select:none;
  }
  .chip.taking{outline:2px dashed #6fe0ff}
  .chip.done{border-color:#2d9c2d; color:#c9ffd0; background:linear-gradient(180deg,#0f1b2a,#0d1f17)}
  .chip.calSel{outline:2px solid #ffd166}

  .hint{color:var(--muted); font-size:13px; margin:4px 0 0}
  .bottom{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  .legend{display:flex; gap:8px; flex-wrap:wrap; font-size:13px; color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block;vertical-align:middle;margin-right:6px}
  .ok{background:var(--good)} .ko{background:var(--bad)} .target{background:var(--target)}

  .stage{position:relative; border:1px solid var(--line); border-radius:var(--radius); overflow:hidden}
  a-scene{position:absolute; inset:0}

  .hud{position:absolute; left:10px; top:10px; display:flex; gap:8px; z-index:5; flex-wrap:wrap;}
  .hud .btn{padding:6px 10px}
  .toast{
    position:absolute; right:12px; top:12px; z-index:6; padding:8px 12px; border-radius:12px;
    border:1px solid #2a3a4e; background:linear-gradient(180deg,#122033,#0d1623); color:#e8f7ff; font-weight:800; display:none
  }
  .toast.show{display:block; animation:pop .25s ease}
  @keyframes pop{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}

  .label3d{pointer-events:auto}

  @media (max-width:960px){
    .wrap{grid-template-columns:1fr; grid-template-rows:auto auto auto auto 1fr; padding:10px}
    .stage{height:65vh; margin-bottom:14px}
    .list{max-height:200px}
  }
  @media (min-width:961px){
    .stage{height:calc(100vh - 24px)}
  }
</style>
</head>
<body>
<div class="wrap">
  <aside class="side">
    <div class="panel topbar">
      <a class="back" href="./index.html">← Volver</a>
      <div class="modes" role="tablist">
        <button id="modeAnimal" class="btn active">Animal</button>
        <button id="modeVegetal" class="btn">Vegetal</button>
      </div>
    </div>

    <div class="panel score">
      <div>Correctas: <span id="ok">0</span> · Incorrectas: <span id="ko">0</span></div>
      <div id="progressMini">0 / <span id="total">0</span></div>
    </div>

    <div class="panel">
      <div style="font-weight:800;margin-bottom:6px">Etiquetas a ubicar</div>
      <div id="chips" class="list" aria-live="polite"></div>
      <div class="hint">Tip (móvil): pellizca para zoom, 1 dedo rota, 2 dedos mueven. En PC: arrastra para rotar, Alt+clic para mover.</div>
    </div>

    <div class="panel bottom">
      <div class="legend">
        <span><i class="dot target"></i>Objetivo</span>
        <span><i class="dot ok"></i>Correcto</span>
        <span><i class="dot ko"></i>Incorrecto</span>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnAyuda" class="btn">Ayuda</button>
        <button id="btnReset" class="btn">Reiniciar</button>
        <button id="btnCalib" class="btn">Calibrar</button>
        <button id="btnCalibClear" class="btn">Borrar calibs.</button>
      </div>
    </div>
  </aside>

  <main class="stage">
    <div class="hud">
      <button id="btnAuto" class="btn">Auto</button>
      <button id="btnCenter" class="btn">◎</button>
      <button id="btnResetView" class="btn">⟲</button>
      <button id="btnZoomIn" class="btn">＋</button>
      <button id="btnZoomOut" class="btn">－</button>
    </div>
    <div id="toast" class="toast">¡Bien!</div>

    <a-scene embedded renderer="antialias:true;precision:mediump" background="color:#000">
      <a-entity light="type:ambient; intensity:0.9"></a-entity>
      <a-entity light="type:directional; intensity:0.8" position="1 1 0"></a-entity>

      <a-entity id="cellModel"
        position="0 0 0" rotation="0 0 0" scale="0.40 0.40 0.40"
        gesture-handler="minScale:0.20; maxScale:3.0; rotFactor:0.5"
        pinch-pan-pe="min:0.20; max:3.0; factor:1; panFactor:1.6"
        mouse-drag-rotate
        mouse-pan="panFactor:1.6"
        tap-reset="scale:0.40; rotYdeg:0"
        auto-rotator="enabled:false; speed:18"></a-entity>

      <a-entity id="cameraRig">
        <a-entity camera position="0 0 1.6" cursor="rayOrigin: mouse"></a-entity>
      </a-entity>
    </a-scene>
  </main>
</div>

<script>
let LOCK_INPUT=false;
AFRAME.registerComponent('gesture-handler',{schema:{rotFactor:{default:0.45},minScale:{default:0.05},maxScale:{default:3.0}},
  init:function(){this.oneFinger=false;this.lastX=0;const s=this.el.sceneEl;const add=()=>{const t=s.canvas||s;
    t.addEventListener('touchstart',e=>{if(e.touches.length===1){this.oneFinger=true;this.lastX=e.touches[0].clientX;}},{passive:false});
    t.addEventListener('touchmove',e=>{if(LOCK_INPUT) return;if(this.oneFinger&&e.touches.length===1){const dx=e.touches[0].clientX-this.lastX;this.lastX=e.touches[0].clientX;
      this.el.object3D.rotation.y-=(dx*this.data.rotFactor)*Math.PI/180;e.preventDefault();}},{passive:false});
    t.addEventListener('touchend',()=>{this.oneFinger=false;},{passive:false});
    t.addEventListener('touchcancel',()=>{this.oneFinger=false;},{passive:false});
    t.addEventListener('wheel',e=>{e.preventDefault();const dir=e.deltaY>0?0.9:1.1;const s=this.el.object3D.scale.x*dir;
      const cl=THREE.MathUtils.clamp(s,this.data.min,this.data.max);this.el.object3D.scale.set(cl,cl,cl);},{passive:false});
    t.addEventListener('contextmenu',(e)=>e.preventDefault());
  }; s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});

AFRAME.registerComponent('mouse-drag-rotate',{schema:{factor:{default:0.45}},
  init:function(){this.drag=false;this.lastX=0;const s=this.el.sceneEl;const add=()=>{const t=s.canvas||s;
    t.addEventListener('mousedown',e=>{ if(LOCK_INPUT) return;if(e.button===0){this.drag=true;this.lastX=e.clientX;}});
    window.addEventListener('mouseup',()=>{this.drag=false;});
    window.addEventListener('mousemove',e=>{ if(LOCK_INPUT) return;if(!this.drag) return; const dx=e.clientX-this.lastX; this.lastX=e.clientX;
      this.el.object3D.rotation.y-=(dx*this.data.factor)*Math.PI/180; });
  }; s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});

AFRAME.registerComponent('mouse-pan',{schema:{panFactor:{default:1.6}},
  init:function(){const s=this.el.sceneEl;let down=false,start={x:0,y:0},startPos=this.el.object3D.position.clone(),shift=false;
    const worldPerPixel=()=>{const cam=s.camera;if(!cam||!s.canvas)return{x:0,y:0};const fov=(cam.fov||60)*Math.PI/180;
      const h=s.canvas.height||window.innerHeight;const y=2*cam.position.length()*Math.tan(fov/2)/h;const x=y*cam.aspect;return{x,y};};
    const onDown=(e)=>{if(LOCK_INPUT) return;shift=e.shiftKey;
      if(e.button===1||e.button===2||(e.button===0&&(shift||e.altKey))){down=true;start={x:e.clientX,y:e.clientY};startPos=this.el.object3D.position.clone();e.preventDefault();}};
    const onMove=(e)=>{if(LOCK_INPUT) return;if(!down) return;e.preventDefault();const dx=e.clientX-start.x,dy=e.clientY-start.y;const wp=worldPerPixel();
      const tx=dx*wp.x*this.data.panFactor;const ty=-dy*wp.y*this.data.panFactor;this.el.object3D.position.set(startPos.x+tx,startPos.y+ty,startPos.z);};
    const onUp=()=>{down=false;};
    const add=()=>{const c=s.canvas||s;c.addEventListener('mousedown',onDown,{passive:false});window.addEventListener('mousemove',onMove,{passive:false});
      window.addEventListener('mouseup',onUp,{passive:false});c.addEventListener('contextmenu',(e)=>e.preventDefault());};
    s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>3D — Célula (etiquetas)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,user-scalable=yes"/>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<style>
  :root{
    --uiScale:1;
    --safeTop: env(safe-area-inset-top, 0px);
    --gap: 8px;
  }
  html,body{margin:0;height:100%;background:#000;overflow:hidden;touch-action:none;overscroll-behavior:contain}
  canvas,.a-canvas{position:fixed;inset:0;width:100vw!important;height:100vh!important;background:#000!important}

  /* Modo pinch-zoom de página */
  body.pinch-page{ touch-action: pinch-zoom !important; }
  body.pinch-page canvas, body.pinch-page .a-canvas{ touch-action: pinch-zoom !important; }

  /* Root de UI escalable */
  .uiRoot{ position:fixed; inset:0; pointer-events:none; transform:scale(var(--uiScale)); transform-origin: top left; }
  .uiRoot > *{ pointer-events:auto; }

  /* CONTENEDOR SUPERIOR (Título + Toolbar + Progreso) */
  .topStack{
    position:fixed; left:0; right:0; top:0;
    padding: calc(var(--safeTop) + 6px) 8px 0 8px;
    display:flex; flex-direction:column; gap:10px;
    z-index:9;
    background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.25),rgba(0,0,0,0));
  }
  .hud{
    color:#fff; font:600 14px/1.1 system-ui;
    padding: 2px 4px 0 4px;
  }

  .toolbar{
    width:100%;
    display:flex; flex-wrap:wrap; gap:var(--gap);
    align-items:center;
    /* Si no cabe, permite arrastre horizontal con el dedo */
    overflow:auto; -webkit-overflow-scrolling:touch;
    padding-bottom:2px;
  }
  .toolbar::-webkit-scrollbar{height:0} /* oculta scrollbar en móvil */
  .btn{
    border:1px solid rgba(255,255,255,.28);
    color:#fff; background:rgba(0,0,0,.35);
    border-radius:10px; padding:8px 12px;
    font:600 13px system-ui; cursor:pointer; white-space:nowrap;
  }
  .btn:focus{ outline:2px solid #3cc9ff66; outline-offset:2px }
  .btn.active{ background:rgba(60,201,255,.25); border-color:#3cc9ff }
  .btn[aria-pressed="true"]{ background:rgba(60,201,255,.25); border-color:#3cc9ff }

  /* Progreso debajo de la toolbar */
  .progressWrap{ display:flex; justify-content:center }
  .progress{
    width:min(90vw,560px); height:10px;
    background:rgba(255,255,255,.15); border-radius:999px;
    overflow:hidden; display:none;
    border:1px solid rgba(57,255,20,.35)
  }
  .progress .bar{
    width:0%; height:100%;
    background:linear-gradient(90deg,#39ff14,#bfff00);
    box-shadow:0 0 12px #39ff14,0 0 24px #39ff14;
    transition:width .15s ease
  }
  .progress .pct{
    position:absolute; right:0; transform:translateY(-120%);
    font:700 12px system-ui; color:#bfff00; text-shadow:0 0 8px #39ff14
  }

  .infoPanel{
    position:fixed; left:10px; top:calc(120px + var(--safeTop));
    z-index:8; width:min(360px,86vw); max-height:60vh; overflow:auto; padding:12px;
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.28); border-radius:14px; backdrop-filter:blur(2px)
  }
  .infoPanel h3{margin:0 0 6px;font:700 16px system-ui;color:#fff}
  .infoPanel h4{margin:10px 0 6px;font:700 13px system-ui;color:#cfe6ff}
  .infoPanel ul{margin:0;padding-left:16px}
  .infoPanel li{margin:2px 0;color:#e9f2ff;font:13px system-ui}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
  .chip{
    padding:6px 8px;border-radius:999px;font:700 12px system-ui;color:#132;
    background:rgba(57,255,20,.15); border:1px solid #39ff14;
    box-shadow:0 0 8px rgba(57,255,20,.5) inset,0 0 6px rgba(57,255,20,.25)
  }

  .controls{
    position:fixed; right:10px; bottom:10px; z-index:8;
    display:grid; grid-template-columns:repeat(3,48px); grid-gap:8px
  }
  .ctrl{
    width:48px;height:48px;border-radius:12px;border:1px solid rgba(255,255,255,.28);
    background:rgba(0,0,0,.45);color:#fff; font:600 20px/48px system-ui;text-align:center;cursor:pointer;
    box-shadow:0 4px 14px rgba(0,0,0,.25)
  }

  .panel{
    position:fixed; left:10px; bottom:10px; z-index:8; padding:8px 10px;
    background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.28); border-radius:10px; min-width:190px
  }
  .panel label{display:flex;align-items:center;gap:6px;font:600 12px system-ui;color:#fff;margin:4px 0}
  .panel input[type=range]{width:130px}

  .listPanel{
    position:fixed; right:10px; top:calc(120px + var(--safeTop)); z-index:8; padding:10px;
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.28); border-radius:12px; min-width:220px
  }
  .listPanel h4{margin:0 0 6px;font:700 13px system-ui;color:#cfe6ff}
  .listPanel select{width:100%;font:600 12px system-ui;padding:6px;border-radius:10px;border:1px solid #3cc9ff;background:#021525;color:#e8fbff}
  .listPanel .row{display:flex;gap:6px;margin-top:8px}
  .listPanel .row .btn{flex:1}

  /* Botón flotante para ocultar UI */
  .hideUI{
    position:fixed; left:10px; top:calc(60px + var(--safeTop)); z-index:10;
    border:1px solid rgba(255,255,255,.28); color:#fff; background:rgba(0,0,0,.45);
    border-radius:999px; padding:6px 10px; font:600 12px system-ui; cursor:pointer
  }

  .ui-hidden .topStack,
  .ui-hidden .infoPanel,
  .ui-hidden .listPanel,
  .ui-hidden .panel,
  .ui-hidden .controls,
  .ui-hidden .hideUI { display:none !important; }

  @media (max-width:480px){
    .controls{grid-gap:6px}
    .ctrl{width:44px;height:44px;font:600 18px/44px system-ui}
    .panel{padding:6px 8px;min-width:170px}
    .panel input[type=range]{width:110px}
    .listPanel{right:8px;min-width:200px}
  }
</style>
</head>
<body>
  <div class="uiRoot">
    <button id="btnHideUI" class="hideUI" title="Ocultar/mostrar interfaz (H)">Ocultar UI</button>

    <div class="topStack" id="topStack">
      <div class="hud" id="hudTitle">3D — Célula <span id="labelKind" style="opacity:.9">Animal</span></div>

      <div class="toolbar" id="toolbar" role="toolbar" aria-label="Controles de vista">
        <button id="btnAnimal" class="btn" aria-pressed="false">Animal</button>
        <button id="btnVegetal" class="btn" aria-pressed="false">Vegetal</button>
        <button id="btnAuto" class="btn" title="Auto-rotación" aria-pressed="false">Auto</button>
        <button id="btnTags" class="btn" title="Mostrar/Ocultar etiquetas" aria-pressed="true">Etiquetas</button>
        <button id="btnDiff" class="btn" title="Resaltar diferencias" aria-pressed="true">Diferencias</button>
        <button id="btnSolo" class="btn" title="Mostrar solo el seleccionado" aria-pressed="false">Solo</button>
        <button id="btnPinchPage" class="btn" title="Pellizcar para hacer zoom de la página (no del modelo)" aria-pressed="false">Pinch página</button>
        <button id="btnInfo" class="btn" title="Ver/Ocultar ficha" aria-pressed="true">Info</button>
      </div>

      <div class="progressWrap">
        <div class="progress" id="progress"><div class="bar" id="progressBar"></div><div class="pct" id="progressPct">0%</div></div>
      </div>
    </div>

    <!-- Ficha EDU -->
    <div class="infoPanel" id="infoPanel"></div>

    <!-- Lista de componentes / acciones -->
    <div class="listPanel" id="listPanel">
      <h4>Componentes</h4>
      <select id="compSelect" aria-label="Selecciona componente"></select>
      <div class="row">
        <button class="btn" id="btnFocus" title="Enfocar (F)">Enfocar</button>
        <button class="btn" id="btnPing"  title="Ping (P)">Ping</button>
      </div>
    </div>

    <!-- Controles -->
    <div class="controls" id="controls">
      <div class="ctrl" id="rotL"   title="Rotar izquierda">↶</div>
      <div class="ctrl" id="reset"  title="Reset">⟲</div>
      <div class="ctrl" id="rotR"   title="Rotar derecha">↷</div>
      <div class="ctrl" id="zoomOut" title="Zoom -">−</div>
      <div class="ctrl" id="center"  title="Centrar">◎</div>
      <div class="ctrl" id="zoomIn"  title="Zoom +">+</div>
    </div>

    <!-- Panel sliders -->
    <div class="panel" id="panel">
      <label>Zoom <input type="range" id="scaleRange" min="0.20" max="3.00" step="0.01" value="0.40" aria-label="Zoom"></label>
      <label>Vel. rotación <input type="range" id="speedRange" min="-60" max="60" step="1" value="20" aria-label="Velocidad auto-rotación"></label>
    </div>
  </div>

  <a-scene embedded renderer="antialias:true;precision:mediump" background="color: #000">
    <a-entity light="type:ambient; intensity:0.9"></a-entity>
    <a-entity light="type:directional; intensity:0.8" position="1 1 0"></a-entity>

    <a-entity id="cellModel"
      position="0 0 0" rotation="0 0 0" scale="0.40 0.40 0.40"
      gesture-handler="minScale:0.20; maxScale:3.0; rotFactor:0.5"
      pinch-scale="min:0.20; max:3.0; factor:1"
      mouse-drag-rotate
      tap-reset="scale:0.40; rotYdeg:0"
      auto-rotator="enabled:false; speed:20"></a-entity>

    <a-entity id="cameraRig">
      <a-entity camera position="0 0 1.4" cursor="rayOrigin: mouse" raycaster="objects: .hs-click"></a-entity>
    </a-entity>
  </a-scene>

<script>
/* =================== Util =================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function toggleBtn(btn, on){
  btn.classList.toggle('active', on);
  btn.setAttribute('aria-pressed', String(!!on));
}
function savePref(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }
function loadPref(key, def){ try{ const v=JSON.parse(localStorage.getItem(key)); return (v===null||v===undefined)?def:v; }catch{ return def; } }

/* =================== Estado global (pinch) =================== */
window.PINCH_MODE = 'model';
function setPinchMode(mode){
  window.PINCH_MODE = mode;
  document.body.classList.toggle('pinch-page', mode==='page');
  // Control del viewport para zoom de página
  let mv = document.querySelector('meta[name="viewport"]');
  if (!mv) { mv = document.createElement('meta'); mv.setAttribute('name','viewport'); document.head.appendChild(mv); }
  mv.setAttribute('content', mode==='page' ? 'width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes'
                                           : 'width=device-width,initial-scale=1,maximum-scale=3,user-scalable=yes');
  savePref('vh_pinch_mode', mode);
}

/* =================== Gestos / componentes =================== */
AFRAME.registerComponent('gesture-handler',{schema:{rotFactor:{default:0.45},minScale:{default:0.05},maxScale:{default:3.0}},
  init:function(){this.oneFinger=false;this.lastX=0;const s=this.el.sceneEl;const add=()=>{const t=s.canvas||s;
    t.addEventListener('touchstart',e=>{ if(window.PINCH_MODE==='page') return; if(e.touches.length===1){this.oneFinger=true;this.lastX=e.touches[0].clientX;}},{passive:false});
    t.addEventListener('touchmove',e=>{ if(window.PINCH_MODE==='page') return; if(this.oneFinger&&e.touches.length===1){const dx=e.touches[0].clientX-this.lastX;this.lastX=e.touches[0].clientX;
      this.el.object3D.rotation.y-=(dx*this.data.rotFactor)*Math.PI/180;e.preventDefault();}},{passive:false});
    t.addEventListener('touchend',()=>{this.oneFinger=false;},{passive:false});
    t.addEventListener('touchcancel',()=>{this.oneFinger=false;},{passive:false});
    t.addEventListener('wheel',e=>{ if(window.PINCH_MODE==='page') return; e.preventDefault();const dir=e.deltaY>0?0.9:1.1;
      const s=this.el.object3D.scale.x*dir;const cl=THREE.MathUtils.clamp(s,this.data.min,this.data.max);this.el.object3D.scale.set(cl,cl,cl);},{passive:false});
  }; s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});

AFRAME.registerComponent('mouse-drag-rotate',{schema:{factor:{default:0.45}},
  init:function(){this.drag=false;this.lastX=0;const s=this.el.sceneEl;const add=()=>{const t=s.canvas||s;
    t.addEventListener('mousedown',e=>{this.drag=true;this.lastX=e.clientX;});
    window.addEventListener('mouseup',()=>{this.drag=false;});
    window.addEventListener('mousemove',e=>{ if(!this.drag) return; const dx=e.clientX-this.lastX; this.lastX=e.clientX;
      this.el.object3D.rotation.y -= (dx*this.data.factor)*Math.PI/180; });
  }; s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});

AFRAME.registerComponent('pinch-scale',{schema:{min:{default:0.1},max:{default:4},factor:{default:1}},
  init:function(){this.active=false;this.startDist=0;this.startScale=this.el.object3D.scale.clone();const s=this.el.sceneEl;const add=()=>{const c=s.canvas||s;
    c.addEventListener('touchstart',e=>{ if(window.PINCH_MODE==='page') return; if(e.touches.length===2){this.active=true;const dx=e.touches[0].clientX-e.touches[1].clientX;const dy=e.touches[0].clientY-e.touches[1].clientY;
      this.startDist=Math.hypot(dx,dy);this.startScale=this.el.object3D.scale.clone();e.preventDefault();}}, {passive:false});
    c.addEventListener('touchmove',e=>{ if(window.PINCH_MODE==='page') return; if(!this.active||e.touches.length!==2)return;const dx=e.touches[0].clientX-e.touches[1].clientX;const dy=e.touches[0].clientY-e.touches[1].clientY;
      const dist=Math.hypot(dx,dy);const k=(dist/this.startDist)*this.data.factor;const sX=THREE.MathUtils.clamp(this.startScale.x*k,this.data.min,this.data.max);
      this.el.object3D.scale.set(sX,sX,sX);e.preventDefault();},{passive:false});
    const end=()=>{this.active=false;};c.addEventListener('touchend',end,{passive:false});c.addEventListener('touchcancel',end,{passive:false});};
  s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});

AFRAME.registerComponent('tap-reset',{schema:{scale:{default:1},rotYdeg:{default:0}},init:function(){this.lastTap=0;const s=this.el.sceneEl;const add=()=>{const t=s.canvas||s;
  t.addEventListener('touchend',()=>{ if(window.PINCH_MODE==='page') return; const n=performance.now();if(n-this.lastTap<300){const sc=this.data.scale;this.el.object3D.scale.set(sc,sc,sc);
    this.el.object3D.rotation.y=THREE.MathUtils.degToRad(this.data.rotYdeg);}this.lastTap=n;},{passive:true});};s.hasLoaded?add():s.addEventListener('loaded',add,{once:true});}});

AFRAME.registerComponent('auto-rotator',{schema:{speed:{default:20},enabled:{default:false}},tick:function(t,dt){
  if(!this.data.enabled)return; this.el.object3D.rotation.y+=THREE.MathUtils.degToRad(this.data.speed)*(dt/1000);
}});

AFRAME.registerComponent('billboard',{tick:function(){const cam=this.el.sceneEl&&this.el.sceneEl.camera;if(!cam)return;this.el.object3D.quaternion.copy(cam.el.object3D.quaternion);}});

/* =================== Datos / contenido =================== */
const HS_DEFAULT={
  animal:[
    {name:'Núcleo',desc:'Controla la célula y guarda el ADN.',pos:[0,0.12,0]},
    {name:'Mitocondrias',desc:'Producen ATP (energía).',pos:[0.18,0.06,0.04]},
    {name:'Aparato de Golgi',desc:'Empaqueta y distribuye proteínas/lípidos.',pos:[0.12,0.00,-0.15]},
    {name:'Ribosomas',desc:'Sintetizan proteínas.',pos:[-0.18,0.08,0]},
    {name:'Lisosomas',desc:'Digestión celular de desechos.',pos:[-0.12,-0.02,0.14],diff:true},
    {name:'Centriolos',desc:'Organizan huso mitótico.',pos:[0.16,0.14,-0.02],diff:true},
    {name:'Membrana plasmática',desc:'Delimita e intercambio.',pos:[0,-0.08,0.2]},
    {name:'Citoplasma',desc:'Medio de reacciones químicas.',pos:[-0.06,0.02,-0.18]}
  ],
  vegetal:[
    {name:'Núcleo',desc:'Controla la célula y guarda el ADN.',pos:[0,0.12,0]},
    {name:'Cloroplastos',desc:'Fotosíntesis: luz → energía química.',pos:[0.18,0.05,0],diff:true},
    {name:'Vacuola central',desc:'Almacenamiento y turgencia.',pos:[-0.12,0.02,-0.1],diff:true},
    {name:'Pared celular',desc:'Rigidez y protección (celulosa).',pos:[0,0,-0.22],diff:true},
    {name:'Plasmodesmos',desc:'Comunicación entre células vegetales.',pos:[-0.20,0.00,0.12],diff:true},
    {name:'Aparato de Golgi',desc:'Empaque y secreción.',pos:[0.12,0,-0.15]},
    {name:'Mitocondrias',desc:'Producción de ATP.',pos:[-0.18,0.06,0.02]},
    {name:'Ribosomas',desc:'Síntesis de proteínas.',pos:[0.0,0.16,0.16]}
  ]
};
const STORAGE_KEY = k => `hs_positions_v1_${k}`;
function loadCustom(kind){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY(kind))||'null'); }catch{ return null; } }
function getHotspots(kind){
  const custom = loadCustom(kind);
  if (!custom) return HS_DEFAULT[kind];
  const byName = new Map((HS_DEFAULT[kind]||[]).map(x=>[x.name,x]));
  return custom.map(c=>({ ...byName.get(c.name)||{}, ...c }));
}

const INIT={ animal:{scale:0.40,rotYdeg:0}, vegetal:{scale:0.36,rotYdeg:0} };
const MIN_SCALE=0.20, MAX_SCALE=3.0, ROT_STEP_DEG=8, ZOOM_STEP=1.12;
const MAP={
  animal:{normal:"./assets/models/animal.glb",draco:"./assets/models/animal_draco.glb"},
  vegetal:{normal:"./assets/models/vegetal.glb",draco:"./assets/models/vegetal_draco.glb"}
};
const CONTENT={
  animal:{titulo:"Célula Animal",
    componentes:[["Núcleo","Controla la célula y guarda el ADN."],["Membrana plasmática","Delimita y regula el intercambio de sustancias."],["Citoplasma","Medio donde ocurren reacciones químicas."],["Ribosomas","Fabrican proteínas."],["R.E. rugoso","Sintetiza y procesa proteínas."],["R.E. liso","Sintetiza lípidos y detoxifica."],["Aparato de Golgi","Empaqueta y distribuye proteínas/lípidos."],["Mitocondrias","Producen ATP (energía)."],["Lisosomas","Digieren desechos y partículas."],["Peroxisomas","Metabolismo de peróxidos."],["Citoesqueleto","Forma, soporte y transporte interno."],["Centriolos","Organizan huso mitótico en división celular."]],
    diferencia:["Sin pared celular","Sin cloroplastos","Vacuolas pequeñas y múltiples","Centriolos presentes","Lisosomas abundantes"]},
  vegetal:{titulo:"Célula Vegetal",
    componentes:[["Núcleo","Controla la célula y guarda el ADN."],["Membrana plasmática","Regula el intercambio con el exterior."],["Pared celular (celulosa)","Aporta rigidez y protección."],["Citoplasma","Medio de reacciones celulares."],["Ribosomas","Síntesis de proteínas."],["R.E. rugoso/liso","Proteínas y lípidos."],["Aparato de Golgi","Empaque y secreción."],["Mitocondrias","Producción de ATP."],["Vacuola central","Almacenamiento y turgencia (presión interna)."],["Cloroplastos","Fotosíntesis: luz → energía química."],["Plasmodesmos","Canales de comunicación entre células vegetales."],["Citoesqueleto","Estructura y transporte."]],
    diferencia:["Pared celular (celulosa)","Cloroplastos (fotosíntesis)","Vacuola central grande","Plasmodesmos","Sin centriolos típicos"]}
};

/* =================== DOM refs =================== */
const params=new URLSearchParams(location.search);
let kind=(params.get('m')||'animal').toLowerCase(); if(!MAP[kind]) kind='animal';

const modelEl=document.getElementById('cellModel');
const labelEl=document.getElementById('labelKind');

const btnA=document.getElementById('btnAnimal');
const btnV=document.getElementById('btnVegetal');
const btnAuto=document.getElementById('btnAuto');
const btnTags=document.getElementById('btnTags');
const btnDiff=document.getElementById('btnDiff');
const btnSolo=document.getElementById('btnSolo');
const btnPinchPage=document.getElementById('btnPinchPage');
const btnInfo=document.getElementById('btnInfo');
const btnHideUI=document.getElementById('btnHideUI');

const compSelect=document.getElementById('compSelect');
const btnFocus=document.getElementById('btnFocus');
const btnPing=document.getElementById('btnPing');

const progress=document.getElementById('progress');
const progressBar=document.getElementById('progressBar');
const progressPct=document.getElementById('progressPct');

/* =================== Progreso =================== */
function showProgress(p){ progress.style.display='block'; setProgress(p); }
function setProgress(p){ const v=Math.max(0,Math.min(1,p||0)); progressBar.style.width=(v*100).toFixed(0)+'%'; progressPct.textContent=(v*100).toFixed(0)+'%'; }
function hideProgress(){ setProgress(1); setTimeout(()=>{progress.style.display='none';},250); }
const manager=THREE.DefaultLoadingManager; manager.onStart=()=>showProgress(0); manager.onProgress=(u,l,t)=>{if(t&&t>0)setProgress(l/t)}; manager.onLoad=()=>hideProgress();

/* =================== Info EDU =================== */
function renderInfo(k){
  const c=CONTENT[k]; let html=`<h3>${c.titulo}</h3><h4>Componentes y función</h4><ul>`;
  for(const [n,d] of c.componentes){ html+=`<li><b>${n}:</b> ${d}</li>`;}
  html+=`</ul><h4>Se diferencia por…</h4><div class="chips">`;
  for(const it of c.diferencia){ html+=`<span class="chip">${it}</span>`;}
  html+=`</div>`;
  document.getElementById('infoPanel').innerHTML=html;
}
function setUI(){
  toggleBtn(btnA, kind==='animal'); toggleBtn(btnV, kind==='vegetal');
  labelEl.textContent=(kind==='animal'?'Animal':'Vegetal');
  renderInfo(kind);
  const u=new URL(location.href); u.searchParams.set('m',kind); history.replaceState(null,'',u.toString());
}

/* =================== Hotspots runtime =================== */
let hsRoot=null, hsRecords=[];
function clearHotspots(){ const old=document.getElementById('hsRoot'); if(old&&old.parentNode) old.parentNode.removeChild(old); hsRecords=[]; compSelect.innerHTML=''; }
function populateSelect(items){ compSelect.innerHTML=''; items.forEach((it,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=it.name; compSelect.appendChild(o); }); }

/* Dibuja hotspots */
function makeHotspots(kind){
  clearHotspots();
  const items = getHotspots(kind) || [];
  hsRoot = document.createElement('a-entity'); hsRoot.setAttribute('id','hsRoot'); modelEl.appendChild(hsRoot);

  const labelsOn = btnTags.classList.contains('active');
  const diffOn   = btnDiff.classList.contains('active');
  const soloOn   = btnSolo.classList.contains('active');
  const selectedIndex = parseInt(compSelect.value||0,10)||0;

  items.forEach((item,idx)=>{
    const wrap=document.createElement('a-entity'); wrap.setAttribute('position', item.pos.join(' '));
    const dot=document.createElement('a-entity'); dot.classList.add('hs-click');
    const isDiff = !!item.diff && diffOn;

    dot.setAttribute('geometry', `primitive: sphere; radius: ${isDiff?0.055:0.035}`);
    dot.setAttribute('material', `color:${isDiff?'#39ff14':'#00d4ff'}; emissive:${isDiff?'#39ff14':'#00a0ff'}; emissiveIntensity:0.85; roughness:0.3; side: double`);
    if(isDiff){ dot.setAttribute('animation','property: scale; dir: alternate; dur:800; loop:true; to:1.25 1.25 1.25; easing:easeInOutSine'); }

    const tip=document.createElement('a-entity'); tip.setAttribute('position','0 0.12 0'); tip.setAttribute('billboard','');
    const bg=document.createElement('a-entity'); bg.setAttribute('geometry','primitive: plane; width: 0.70; height: auto');
    bg.setAttribute('material',`color:${isDiff?'#052b00':'#000'}; opacity:${isDiff?0.85:0.78}; side: double`);
    const txt=document.createElement('a-text'); txt.setAttribute('value',`${item.name}: ${item.desc}`);
    txt.setAttribute('color', isDiff ? '#bfff00' : '#fff'); txt.setAttribute('align','center'); txt.setAttribute('width','1.45'); txt.setAttribute('wrap-count','32');

    const stem=document.createElement('a-entity');
    stem.setAttribute('geometry','primitive: cylinder; radius: 0.0025; height: 0.12');
    stem.setAttribute('rotation','90 0 0'); stem.setAttribute('position','0 0.06 0');
    stem.setAttribute('material', `color:${isDiff?'#39ff14':'#9ad7ff'}; opacity:0.9`);

    tip.appendChild(bg); tip.appendChild(txt);

    const showThis = labelsOn && (!soloOn || idx===selectedIndex);
    tip.setAttribute('visible', showThis);
    if (showThis) wrap.appendChild(stem);
    wrap.appendChild(dot); wrap.appendChild(tip);

    wrap.addEventListener('click', ()=>{
      dot.emit('ping');
      if (btnSolo.classList.contains('active')) {
        compSelect.value = idx;
        applySoloFilter();
      } else {
        tip.setAttribute('visible','true');
        setTimeout(()=> tip.setAttribute('visible','false'), 2000);
      }
    });
    dot.setAttribute('animation__ping','property: scale; startEvents: ping; dir: alternate; dur:240; loop:2; to:1.5 1.5 1.5; easing:easeOutSine');

    hsRoot.appendChild(wrap); hsRecords.push({name:item.name, wrap, dot, tip, stem, idx});
  });

  populateSelect(items);
}
function applySoloFilter(){
  const solo = btnSolo.classList.contains('active');
  const idx = parseInt(compSelect.value||0,10)||0;
  const showLabels = btnTags.classList.contains('active');
  hsRecords.forEach(r=>{
    const show = solo ? (r.idx===idx) : showLabels;
    r.tip.setAttribute('visible', show);
    if (show && !r.stem.parentNode) r.wrap.appendChild(r.stem);
    if (!show && r.stem.parentNode) r.wrap.removeChild(r.stem);
  });
}
function focusHotspot(index){
  const rec = hsRecords[index]; if(!rec) return;
  const p = rec.wrap.object3D.position.clone();
  const angle = Math.atan2(p.x, p.z);
  const start = modelEl.object3D.rotation.y;
  const end = angle;
  const dur = 450; const t0 = performance.now();
  function anim(now){
    const k=Math.min(1,(now-t0)/dur);
    modelEl.object3D.rotation.y = THREE.MathUtils.lerp(start,end,k);
    if(k<1) requestAnimationFrame(anim);
  }
  requestAnimationFrame(anim);
  rec.dot.emit('ping');
}

/* =================== Normalizar & encuadrar =================== */
function frameCameraOnly(){
  const scene=modelEl.sceneEl; if(!scene) return;
  const cam=scene.camera; if(!cam) return;
  const THREE = window.THREE;
  const box = new THREE.Box3().setFromObject(modelEl.object3D);
  const sphere = box.getBoundingSphere(new THREE.Sphere());
  const radius = sphere.radius * 1.12;
  const fov = (cam.fov||60)*Math.PI/180;
  const aspect = cam.aspect || (scene.canvas ? scene.canvas.width/scene.canvas.height : 1.777);
  const distV = radius / Math.sin(fov/2);
  const hFov = 2*Math.atan(Math.tan(fov/2)*aspect);
  const distH = radius / Math.sin(hFov/2);
  const dist = Math.max(distV,distH);
  cam.el?.setAttribute('position', `0 0 ${dist.toFixed(4)}`);
  cam.near=Math.max(0.01,dist*0.01); cam.far=dist*10; cam.updateProjectionMatrix();
}
function normalizeAndFrame(){
  const THREE = window.THREE;
  const mesh = modelEl.getObject3D('mesh'); if(!mesh) return;
  const box = new THREE.Box3().setFromObject(mesh);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());
  const maxDim = Math.max(size.x,size.y,size.z) || 1;
  mesh.position.sub(center);
  const s  = (kind==='animal'?0.30:0.30) / maxDim;
  modelEl.object3D.scale.set(s,s,s);
  frameCameraOnly();
}
window.addEventListener('resize', ()=>{ frameCameraOnly(); });

/* =================== Carga del modelo =================== */
async function exists(u){ try{ const r=await fetch(u+'?t='+Date.now(),{method:'HEAD'}); return r.ok; }catch{return false;} }
async function pick(){ const e=MAP[kind]; return (await exists(e.draco))?e.draco:e.normal; }
async function load(){
  showProgress(0);
  const url=(await pick())+'#'+Date.now(); const init=INIT[kind]||INIT.animal;

  modelEl.removeAttribute('gltf-model');
  modelEl.object3D.scale.set(init.scale,init.scale,init.scale);
  modelEl.object3D.rotation.set(0,THREE.MathUtils.degToRad(init.rotYdeg),0);
  modelEl.object3D.position.set(0,0,0);
  document.getElementById('scaleRange').value=init.scale;

  modelEl.setAttribute('auto-rotator',`enabled:${btnAuto.classList.contains('active')}; speed:${parseFloat(document.getElementById('speedRange').value)}`);
  clearHotspots();
  setTimeout(()=>modelEl.setAttribute('gltf-model',url),30);
}

/* =================== Botones / eventos =================== */
function restoreTogglesFromStorage(){
  toggleBtn(btnTags, loadPref('vh_tags', true));
  toggleBtn(btnDiff, loadPref('vh_diff', true));
  toggleBtn(btnSolo, loadPref('vh_solo', false));
  const pm = loadPref('vh_pinch_mode','model'); setPinchMode(pm);
  toggleBtn(btnPinchPage, pm==='page');
  toggleBtn(btnInfo, loadPref('vh_info', true));
  document.getElementById('infoPanel').style.display = btnInfo.classList.contains('active') ? 'block' : 'none';
}
btnA.onclick=()=>{ kind='animal'; setUI(); load(); };
btnV.onclick=()=>{ kind='vegetal'; setUI(); load(); };
btnAuto.onclick=()=>{ const en=!btnAuto.classList.contains('active'); toggleBtn(btnAuto,en);
  modelEl.setAttribute('auto-rotator',`enabled:${en}; speed:${parseFloat(document.getElementById('speedRange').value)}`);};

btnInfo.onclick=()=>{ const on=!btnInfo.classList.contains('active'); toggleBtn(btnInfo,on);
  document.getElementById('infoPanel').style.display= on?'block':'none'; savePref('vh_info', on); };

btnTags.onclick=()=>{ const on=!btnTags.classList.contains('active'); toggleBtn(btnTags,on); savePref('vh_tags', on); makeHotspots(kind); };
btnDiff.onclick=()=>{ const on=!btnDiff.classList.contains('active'); toggleBtn(btnDiff,on); savePref('vh_diff', on); makeHotspots(kind); };
btnSolo.onclick=()=>{ const on=!btnSolo.classList.contains('active'); toggleBtn(btnSolo,on); savePref('vh_solo', on); applySoloFilter(); };

btnPinchPage.onclick=()=>{ const page = window.PINCH_MODE!=='page'; setPinchMode(page?'page':'model'); toggleBtn(btnPinchPage, page); };

document.getElementById('rotL').addEventListener('click',()=>{ modelEl.object3D.rotation.y+=THREE.MathUtils.degToRad(ROT_STEP_DEG); });
document.getElementById('rotR').addEventListener('click',()=>{ modelEl.object3D.rotation.y-=THREE.MathUtils.degToRad(ROT_STEP_DEG); });
document.getElementById('zoomIn').addEventListener('click',()=> setScaleUniform(modelEl.object3D.scale.x*ZOOM_STEP));
document.getElementById('zoomOut').addEventListener('click',()=> setScaleUniform(modelEl.object3D.scale.x/ZOOM_STEP));
document.getElementById('reset').addEventListener('click',()=>{ const init=INIT[kind]||INIT.animal; modelEl.object3D.scale.set(init.scale,init.scale,init.scale);
  modelEl.object3D.rotation.set(0,THREE.MathUtils.degToRad(init.rotYdeg),0); document.getElementById('scaleRange').value=init.scale; });
document.getElementById('center').addEventListener('click',()=> modelEl.object3D.position.set(0,0,0));
document.getElementById('scaleRange').addEventListener('input',()=> setScaleUniform(parseFloat(document.getElementById('scaleRange').value)));
document.getElementById('speedRange').addEventListener('input',()=>{ const en=btnAuto.classList.contains('active'); modelEl.setAttribute('auto-rotator',`enabled:${en}; speed:${parseFloat(document.getElementById('speedRange').value)}`); });

function clampScale(s){ return Math.min(Math.max(s,MIN_SCALE),MAX_SCALE); }
function setScaleUniform(s){ s=clampScale(s); modelEl.object3D.scale.set(s,s,s); document.getElementById('scaleRange').value=s.toFixed(2); }

compSelect.addEventListener('change', applySoloFilter);
btnFocus.onclick = ()=> focusHotspot(parseInt(compSelect.value||0,10)||0);
btnPing.onclick  = ()=> { const rec=hsRecords[parseInt(compSelect.value||0,10)||0]; rec && rec.dot.emit('ping'); };

/* Ocultar/mostrar UI */
btnHideUI.addEventListener('click', ()=>{
  document.body.classList.toggle('ui-hidden');
  btnHideUI.textContent = document.body.classList.contains('ui-hidden') ? 'Mostrar UI' : 'Ocultar UI';
});
window.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase()==='h'){ btnHideUI.click(); }
  if(e.key.toLowerCase()==='f'){ btnFocus.click(); }
  if(e.key.toLowerCase()==='p'){ btnPing.click(); }
});

/* =================== Eventos de carga =================== */
modelEl.addEventListener('model-loaded',()=>{ hideProgress(); normalizeAndFrame(); makeHotspots(kind); });
modelEl.addEventListener('model-error',e=>{ hideProgress(); alert('No se pudo cargar el modelo.'); console.error(e.detail);});

/* =================== Inicio =================== */
(function init(){
  // Restaura toggles/estado UI
  restoreTogglesFromStorage();
  setUI();
  load();
})();
</script>
</body>
</html>
